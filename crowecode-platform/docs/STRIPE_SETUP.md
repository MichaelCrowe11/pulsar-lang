# CroweCode Stripe Integration Setup Guide

## Overview
CroweCode uses Stripe for subscription billing and payment processing. This guide covers the complete setup process for integrating Stripe with the platform.

## Pricing Structure

### Subscription Plans

| Plan | Price | Features | Target |
|------|-------|----------|--------|
| **Pro** | $20/month | â€¢ 3 workspaces<br>â€¢ 4 vCPU / 8GB RAM<br>â€¢ 25GB storage<br>â€¢ 1,000 AI prompts/month<br>â€¢ 14-day free trial | Individual developers |
| **Team** | $200/month | â€¢ Unlimited workspaces<br>â€¢ 8 vCPU / 32GB RAM<br>â€¢ 100GB storage<br>â€¢ 10,000 AI prompts/month<br>â€¢ SSO support<br>â€¢ Team collaboration<br>â€¢ 14-day free trial | Small to medium teams |
| **Enterprise+** | $299/month per seat | â€¢ Unlimited workspaces<br>â€¢ GPU support<br>â€¢ 25,000 AI prompts/month<br>â€¢ VPC & SAML<br>â€¢ 24/7 support<br>â€¢ 99.9% SLA<br>â€¢ Custom discounts | Large organizations |

### Add-ons

| Add-on | Price | Description | Billing |
|--------|-------|-------------|---------|
| **Compute Credits** | $2/hour | Additional heavy workspace usage beyond plan limits | Metered (usage-based) |

## Setup Instructions

### 1. Prerequisites

- Stripe account (create at [stripe.com](https://stripe.com))
- Node.js 20+ or Python 3.8+
- Access to production environment variables

### 2. Environment Variables

Add these to your `.env.local` file:

```env
# Stripe API Keys
STRIPE_SECRET_KEY=sk_live_...  # Or sk_test_... for testing
STRIPE_PUBLISHABLE_KEY=pk_live_...  # Or pk_test_... for testing
STRIPE_WEBHOOK_SECRET=whsec_...

# Price IDs (will be generated by setup script)
CROWECODE_PRO_PRICE_ID=price_...
CROWECODE_TEAM_PRICE_ID=price_...
CROWECODE_ENTERPRISE_PLUS_PRICE_ID=price_...
CROWECODE_COMPUTE_CREDITS_PRICE_ID=price_...
```

### 3. Create Products and Prices

#### Option A: Using TypeScript (Recommended)

```bash
# Install dependencies
npm install

# Run setup script
npx tsx scripts/setup-stripe-pricing.ts
```

#### Option B: Using Python

```bash
# Install Stripe SDK
pip install stripe python-dotenv

# Run setup script
python scripts/setup_stripe_pricing.py
```

The script will:
1. Create products in Stripe
2. Set up pricing for each plan
3. Configure trial periods
4. Output price IDs for your environment

### 4. Configure Webhooks

1. Go to [Stripe Dashboard â†’ Webhooks](https://dashboard.stripe.com/webhooks)
2. Click "Add endpoint"
3. Enter endpoint URL:
   - Production: `https://crowecode-main.fly.dev/api/stripe/webhook`
   - Development: Use [Stripe CLI](https://docs.stripe.com/stripe-cli) for local testing
4. Select events to listen for:
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
   - `customer.updated`
   - `payment_method.attached`
5. Copy the webhook signing secret to `STRIPE_WEBHOOK_SECRET`

### 5. Test the Integration

#### Test Cards

Use these test cards in development:
- **Success**: `4242 4242 4242 4242`
- **Decline**: `4000 0000 0000 0002`
- **3D Secure**: `4000 0025 0000 3155`

#### Test Checkout Flow

1. Start development server:
   ```bash
   npm run dev
   ```

2. Navigate to pricing page:
   ```
   http://localhost:3000/pricing
   ```

3. Click "Subscribe" on any plan
4. Complete checkout with test card
5. Verify subscription in Stripe Dashboard

### 6. Deploy to Production

1. Set production environment variables on Fly.io:
   ```bash
   fly secrets set STRIPE_SECRET_KEY="sk_live_..." --app crowecode-main
   fly secrets set STRIPE_PUBLISHABLE_KEY="pk_live_..." --app crowecode-main
   fly secrets set STRIPE_WEBHOOK_SECRET="whsec_..." --app crowecode-main
   ```

2. Set price IDs:
   ```bash
   fly secrets set CROWECODE_PRO_PRICE_ID="price_..." --app crowecode-main
   fly secrets set CROWECODE_TEAM_PRICE_ID="price_..." --app crowecode-main
   fly secrets set CROWECODE_ENTERPRISE_PLUS_PRICE_ID="price_..." --app crowecode-main
   fly secrets set CROWECODE_COMPUTE_CREDITS_PRICE_ID="price_..." --app crowecode-main
   ```

3. Deploy application:
   ```bash
   fly deploy --app crowecode-main
   ```

## Usage-Based Billing (Compute Credits)

### Recording Usage

The platform automatically tracks compute hours and reports them to Stripe:

```typescript
// Example: Report compute usage
await stripe.subscriptionItems.createUsageRecord(
  subscriptionItemId,
  {
    quantity: hoursUsed,
    timestamp: Math.floor(Date.now() / 1000),
    action: 'increment',
  }
);
```

### Billing Cycle

- Usage is aggregated monthly
- Billed at the end of each billing period
- $2 per hour of heavy compute usage
- Prorated for partial hours

## Customer Portal

Enable self-service subscription management:

1. Configure portal in [Stripe Dashboard](https://dashboard.stripe.com/settings/billing/portal)
2. Enable features:
   - Update payment methods
   - Cancel subscriptions
   - Download invoices
   - Switch plans
3. Link available at: `/api/stripe/portal`

## Monitoring and Analytics

### Key Metrics to Track

- **MRR** (Monthly Recurring Revenue)
- **Churn rate**
- **Trial conversion rate**
- **Failed payment rate**
- **Average revenue per user (ARPU)**

### Stripe Dashboard Reports

Access analytics at [dashboard.stripe.com/reports](https://dashboard.stripe.com/reports):
- Revenue reports
- Subscription analytics
- Customer lifetime value
- Payment success rates

## Security Best Practices

1. **Never expose secret keys** in client-side code
2. **Always verify webhooks** using signing secret
3. **Use HTTPS** for all API calls
4. **Implement rate limiting** on checkout endpoints
5. **Log all subscription changes** for audit trail
6. **Enable 2FA** on Stripe account
7. **Rotate API keys** periodically

## Troubleshooting

### Common Issues

#### Webhook Failures
- Check endpoint URL is correct
- Verify signing secret matches
- Ensure server can receive POST requests
- Check webhook logs in Stripe Dashboard

#### Subscription Not Created
- Verify price IDs are correct
- Check customer has valid payment method
- Review Stripe logs for errors
- Ensure webhook handler processes events

#### Payment Failures
- Check card details are valid
- Verify billing address if required
- Handle 3D Secure authentication
- Implement retry logic for failed payments

## Support

- **Stripe Support**: [support.stripe.com](https://support.stripe.com)
- **API Documentation**: [docs.stripe.com](https://docs.stripe.com)
- **Status Page**: [status.stripe.com](https://status.stripe.com)

## Next Steps

1. âœ… Run setup script to create products
2. âœ… Configure webhooks
3. âœ… Test checkout flow
4. ðŸ”„ Implement subscription management UI
5. ðŸ”„ Add usage tracking for compute credits
6. ðŸ”„ Set up customer portal
7. ðŸ”„ Configure email notifications
8. ðŸ”„ Implement analytics dashboard

---

*Last updated: January 2025*